
# Инструкция: Как настроить маршрутизацию сайтов на разные прокси через Privoxy

Privoxy — это прокси-сервер с функциями фильтрации, который позволяет гибко настраивать маршрутизацию запросов к различным прокси или прямой доступ. В этой инструкции описан процесс настройки Privoxy для маршрутизации сайтов через разные прокси-серверы.

## Требования
- Установленный Privoxy (доступен для Windows, Linux, macOS).
- Доступ к файлам конфигурации Privoxy (`config.txt` и `user.action`).
- Данные о прокси-серверах (IP, порт, тип: HTTP, SOCKS5 и т.д.).

## Установка Privoxy
1. **Windows**:
   - Скачайте установщик с [официального сайта Privoxy](https://www.privoxy.org/).
   - Установите программу, следуя инструкциям.
2. **Linux**:
~~~
sudo apt update
sudo apt install privoxy
~~~
3. **macOS** (через Homebrew):
~~~
brew install privoxy
~~~

## Настройка Privoxy
Файлы конфигурации обычно находятся:
- Windows: в папке установки Privoxy (например, `C:\Program Files\Privoxy\config.txt`).
- Linux: `/etc/privoxy/config`.
- macOS: `/usr/local/etc/privoxy/config`.

### 1. Настройка основного конфигурационного файла (`config.txt`)
Файл `config.txt` задаёт параметры работы Privoxy: порт, логирование, доступ и т.д.

~~~
listen-address  127.0.0.1:8118
listen-address  0.0.0.0:8118  # Разрешить подключение извне

permit-access 127.0.0.1 10.0.0.0/8  # Разрешённые IP для подключения

logfile /var/log/privoxy.log  # Путь к лог-файлу (Windows: c:\temp\privoxy.log)
debug 1      # Логировать запросы
debug 2      # Логировать перенаправления
debug 512    # Логировать детали соединений

enable-edit-actions 1  # Включить редактирование конфига через веб-интерфейс

actionsfile user.action  # Подключить файл с правилами маршрутизации
~~~

**Объяснение параметров**:
- `listen-address`: IP и порт, на которых Privoxy принимает соединения. `0.0.0.0:8118` разрешает подключение с любых адресов.
- `permit-access`: Ограничивает доступ к Privoxy только указанным IP.
- `logfile`: Путь для сохранения логов.
- `debug`: Уровень логирования (1 — запросы, 2 — перенаправления, 512 — детали соединений).
- `enable-edit-actions`: Включает веб-интерфейс для редактирования настроек (доступ по `http://config.privoxy.org`).
- `actionsfile`: Указывает файл с правилами маршрутизации.

### 2. Настройка правил маршрутизации (`user.action`)
Файл `user.action` определяет, какие сайты через какие прокси направлять или отправлять напрямую.

~~~
# Прямой доступ (обход прокси)
{+forward-override{forward .}}
.local
127.0.0.1
.localhost

# Прокси SOCKS5 (например, через PuTTY или SSH-туннель)
{+forward-override{forward-socks5 127.0.0.1:3128 .}}
.x.com
.twimg.com
.t.co

# Прокси HTTP для определённых доменов
{+forward-override{forward 192.168.1.100:8080 .}}
.example.com
.test.org

# Основной прокси для всех остальных запросов
forward / 172.16.0.1:8080
~~~

**Объяснение правил**:
- `{+forward-override{forward .}}`: Отправляет запросы напрямую, минуя прокси. Используется для локальных адресов (`.local`, `127.0.0.1`).
- `{+forward-override{forward-socks5 <IP>:<port> .}}`: Направляет запросы через SOCKS5-прокси для указанных доменов (например, `.x.com`).
- `{+forward-override{forward <IP>:<port> .}}`: Направляет запросы через HTTP-прокси для указанных доменов.
- `forward / <IP>:<port>`: Устанавливает прокси по умолчанию для всех остальных запросов.

### 3. Проверка и запуск
1. **Проверьте синтаксис конфигурации**:
   - Windows: Запустите `privoxy --config-test` в командной строке.
   - Linux/macOS:
~~~
privoxy --config-test /etc/privoxy/config
~~~
2. **Перезапустите Privoxy**:
   - Windows: Перезапустите службу через «Службы» или перезапустите программу.
   - Linux:
~~~
sudo systemctl restart privoxy
~~~
   - macOS:
~~~
brew services restart privoxy
~~~
3. **Проверьте логи** (по пути, указанному в `logfile`), чтобы убедиться, что запросы маршрутизируются корректно.

### 4. Настройка клиента
Настройте браузер или устройство для использования Privoxy:
- В настройках прокси укажите `127.0.0.1:8118` (или IP сервера, где работает Privoxy, и порт 8118).
- Пример для Firefox:
  - Откройте настройки → Сеть → Настроить прокси.
  - Выберите «Ручная настройка прокси».
  - Укажите HTTP-прокси: `127.0.0.1`, порт `8118`.

### 5. Тестирование
1. Перейдите на сайт, указанный в `user.action` (например, `x.com`).
2. Проверьте в логах Privoxy, через какой прокси пошёл запрос.
3. Убедитесь, что локальные адреса открываются напрямую, а остальные сайты — через указанные прокси.

### 6. Дополнительные советы
- **Веб-интерфейс**: Если включён `enable-edit-actions`, откройте `http://config.privoxy.org` для проверки и редактирования настроек.
- **Логирование**: Используйте `debug` для диагностики, но отключайте в продакшене, чтобы снизить нагрузку.
- **Безопасность**: Ограничьте доступ (`permit-access`) только доверенными IP, особенно если `listen-address 0.0.0.0`.

## Пример сценария
- Локальные сайты (`.local`, `127.0.0.1`) открываются напрямую.
- Социальные сети (`x.com`, `t.co`) идут через SOCKS5-прокси на `127.0.0.1:3128`.
- Корпоративные сайты (`.example.com`) идут через HTTP-прокси на `192.168.1.100:8080`.
- Все остальные запросы перенаправляются через основной прокси `172.16.0.1:8080`.

## Возможные проблемы и решения
- **Privoxy не запускается**:
  - Проверьте, не занят ли порт 8118 (`netstat -an | grep 8118`).
  - Убедитесь, что пути к файлам в `config.txt` корректны.
- **Сайты не открываются**:
  - Проверьте доступность прокси-серверов.
  - Убедитесь, что домены в `user.action` указаны правильно (например, `.x.com` включает поддомены).
- **Логи пустые**:
  - Проверьте, включено ли логирование (`debug`) и правильный ли путь в `logfile`.

Теперь Privoxy готов к маршрутизации запросов через разные прокси в зависимости от домена
